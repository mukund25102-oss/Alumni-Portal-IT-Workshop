<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            /* Soothing dark navy gradient */
            background: linear-gradient(180deg, #070a12 0%, #0a1020 60%, #0b1422 100%);
            color-scheme: dark;
            color: #e6e6f0; /* light text for contrast on dark background */
        }

        /* New decorative unequal purple strips across the page */
        .bg-strips {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -3; /* behind canvas and content */
            overflow: hidden;
        }
        .bg-strips .strip {
            position: absolute;
            top: -10%;
            bottom: -10%;
            transform-origin: center;
            filter: blur(10px) contrast(108%);
            opacity: 0.18;
            mix-blend-mode: screen;
        }
        /* unequal purple strips with different widths/rotations */
        .bg-strips .s1 { left: -18%; width: 36%; background: linear-gradient(180deg, rgba(139,92,246,0.95), rgba(124,58,237,0.75)); transform: rotate(-12deg) translateY(-6%); }
        .bg-strips .s2 { left: 10%; width: 28%; background: linear-gradient(180deg, rgba(167,139,250,0.82), rgba(124,58,237,0.55)); transform: rotate(-6deg) translateY(4%); opacity: 0.16; }
        .bg-strips .s3 { left: 40%; width: 30%; background: linear-gradient(180deg, rgba(99,102,241,0.84), rgba(139,92,246,0.55)); transform: rotate(-20deg) translateY(-2%); opacity: 0.18; }
        .bg-strips .s4 { left: 68%; width: 26%; background: linear-gradient(180deg, rgba(120,74,255,0.8), rgba(99,102,241,0.52)); transform: rotate(-8deg) translateY(6%); opacity: 0.14; }

        /* subtle movement across strips */
        @keyframes stripDrift {
            0% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-12px) rotate(-1deg); }
            100% { transform: translateY(0) rotate(-2deg); }
        }
        .bg-strips .strip { animation: stripDrift 18s ease-in-out infinite; }

        /* Hide the old canvas animation to avoid visual clutter */
        #plexus-canvas { display: none; }

        /* Card animation: idle float + hover lift + purple glow */
        .role-card { transition: transform 0.45s cubic-bezier(.2,.9,.2,1), box-shadow 0.35s ease, border-color 0.35s ease, opacity 0.5s ease; }
        .role-card { transform: translateZ(0); }
        .role-card.idle-float { animation: cardFloat 6s ease-in-out infinite; }
        @keyframes cardFloat {
            0% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0); }
        }
        .role-card:hover { transform: translateY(-14px) scale(1.02); box-shadow: 0 20px 40px rgba(124,58,237,0.18); border-color: rgba(124,58,237,0.12); }
        .role-card .icon-wrap { transition: transform 0.45s ease, box-shadow 0.45s ease; }
        .role-card:hover .icon-wrap { transform: scale(1.08) translateY(-4px); box-shadow: 0 10px 30px rgba(139,92,246,0.18); }

    /* Ensure role cards are legible on the dark page even if Tailwind classes are not applied
       Target [data-role] so styles apply even when JS rewrites the element's className. */
    [data-role], .role-card {
        background: rgba(255,255,255,0.96) !important;
        color: #06201f !important;
        padding: 1.25rem !important;
        border-radius: 1rem !important;
        border: 1px solid rgba(2,6,23,0.06) !important;
        display: block !important;
    }
    [data-role] h3, .role-card h3 { color: #06201f !important; }
    [data-role] p, .role-card p { color: #334155 !important; }
    [data-role] .flex span, .role-card .flex span { color: #0f172a !important; }

    /* Back button color (visible on white panels) */
    #backButton { color: #0b1220; transition: color 160ms ease; }
    #backButton:hover { color: #7c3aed; }

    /* Toast / notification text should be dark on white toast background */
    .toast { color: #0b1220; background: #ffffff; }
    .toast .flex i { opacity: 0.95; }

        /* Respect reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .bg-strips .strip { animation: none !important; }
            .role-card.idle-float { animation: none !important; }
        }

        /* Enhanced Animations */
        .fade-in {
            animation: fadeIn 0.8s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-out-left {
            animation: slideOutLeft 0.6s ease-in-out forwards;
        }
        @keyframes slideOutLeft {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-100px); }
        }

        .slide-in-right {
            animation: slideInRight 0.6s ease-in-out forwards;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .slide-in-left {
            animation: slideInLeft 0.6s ease-in-out forwards;
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .slide-out-right {
            animation: slideOutRight 0.6s ease-in-out forwards;
        }
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }

        /* Enhanced Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .ripple:active::before {
            width: 300px;
            height: 300px;
        }

        /* Card Hover Effects */
        .role-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .role-card:hover::before {
            left: 100%;
        }

        /* Input Focus Effects */
        .input-focus {
            position: relative;
        }
        .input-focus::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-gradient);
            transition: width 0.3s ease;
        }
        .input-focus:focus-within::after {
            width: 100%;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            min-width: 300px;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            border-left: 4px solid #10b981;
        }
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Modal Enhancements */
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
            backdrop-filter: blur(5px);
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Password Strength Indicator */
        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .strength-bar {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        .strength-weak { background: #ef4444; width: 25%; }
        .strength-fair { background: #f59e0b; width: 50%; }
        .strength-good { background: #3b82f6; width: 75%; }
        .strength-strong { background: #10b981; width: 100%; }

        /* Pulse Animation for Important Elements */
        .pulse-glow {
            animation: pulseGlow 3.2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 4px rgba(102, 126, 234, 0.35); }
            50% { box-shadow: 0 0 12px rgba(102, 126, 234, 0.55); }
        }

        /* Scroll-reveal (soothing) */
        .reveal { opacity: 0; transform: translateY(18px) scale(0.98); transition: opacity 0.6s ease, transform 0.6s ease; }
        .reveal.in-view { opacity: 1; transform: translateY(0) scale(1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen overflow-hidden">

    <!-- decorative unequal purple strips for black background -->
    <div class="bg-strips" aria-hidden="true">
        <div class="strip s1"></div>
        <div class="strip s2"></div>
        <div class="strip s3"></div>
        <div class="strip s4"></div>
    </div>

    <!-- old canvas hidden for this theme -->
    <canvas id="plexus-canvas"></canvas>

    <div id="toastContainer"></div>

    <div class="w-full max-w-4xl px-4">
        <div id="roleSelectionContainer" class="fade-in">
            <div class="text-center mb-8">
                <div class="w-24 h-24 mx-auto mb-4 rounded-full overflow-hidden shadow-lg bg-white p-2">
                    <img src="images/iiit.jpg" 
                         alt="IIIT Naya Raipur Logo" 
                         class="w-full h-full object-cover rounded-full">
                </div>
                <h2 class="text-3xl font-bold text-center text-white relative">
                    IIIT NR Alumni Portal
                    <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-16 h-1 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full"></div>
                </h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="role-card group pulse-glow idle-float" data-role="Alumni" data-color="indigo">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-user-graduate text-white text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-black mb-2">Alumni</h3>
                        <p class="text-sm text-gray-700 font-medium mb-3">Graduate Network</p>
                        <p class="text-sm text-gray-600 leading-relaxed mb-4">Connect with the alumni network and access career services.</p>
                        <div class="flex items-center justify-center text-indigo-600 text-sm">
                            <i class="fas fa-arrow-right mr-2 group-hover:translate-x-1 transition-transform duration-300"></i>
                            <span>Access Portal</span>
                        </div>
                    </div>
                </div>
                <div class="role-card group pulse-glow idle-float" data-role="Student" data-color="sky">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-sky-500 to-sky-600 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-book-reader text-white text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-black mb-2">Student</h3>
                        <p class="text-sm text-gray-700 font-medium mb-3">Current Student</p>
                        <p class="text-sm text-gray-600 leading-relaxed mb-4">Explore and connect with the alumni network.</p>
                        <div class="flex items-center justify-center text-sky-600 text-sm">
                            <i class="fas fa-arrow-right mr-2 group-hover:translate-x-1 transition-transform duration-300"></i>
                            <span>Access Portal</span>
                        </div>
                    </div>
                </div>
                <div class="role-card group pulse-glow idle-float" data-role="Administrator" data-color="slate">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-slate-500 to-slate-600 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-user-shield text-white text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-black mb-2">Administrator</h3>
                        <p class="text-sm text-gray-700 font-medium mb-3">Staff Access</p>
                        <p class="text-sm text-gray-600 leading-relaxed mb-4">Administrative access to university management tools.</p>
                        <div class="flex items-center justify-center text-slate-600 text-sm">
                            <i class="fas fa-arrow-right mr-2 group-hover:translate-x-1 transition-transform duration-300"></i>
                            <span>Access Portal</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loginFormContainer" class="w-full max-w-md mx-auto hidden">
             <div class="bg-white/90 backdrop-blur-md p-6 rounded-2xl shadow-2xl relative border border-white/20 text-black">
                <button id="backButton" class="absolute top-4 left-4 transition-all duration-300 hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div class="text-center mb-6">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-full overflow-hidden shadow-lg bg-white p-2">
                        <img src="images/iiit.jpg" 
                             alt="IIIT Naya Raipur Logo" 
                             class="w-full h-full object-cover rounded-full">
                    </div>
                    <h2 id="formTitle" class="text-3xl font-bold tracking-tight">Login</h2>
                    <p class="text-black text-sm mt-2">Welcome back! Please sign in to continue.</p>
                </div>
                <form id="loginForm" class="space-y-5">
                    <div class="input-focus">
                        <label for="userId" class="block text-black text-sm font-medium mb-2">
                            <i class="fas fa-user mr-2 text-gray-700"></i>User ID
                        </label>
                        <input type="text" id="userId" name="userId" placeholder="Enter your ID" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 bg-gray-50 focus:bg-white">
                    </div>
                    <div class="input-focus">
                        <label for="password" class="block text-black text-sm font-medium mb-2">
                            <i class="fas fa-key mr-2 text-gray-700"></i>Password
                        </label>
                        <div class="relative">
                            <input type="password" id="password" name="password" placeholder="••••••••" required 
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 bg-gray-50 focus:bg-white">
                            <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-700 hover:text-black transition-colors">
                                <i class="fas fa-eye" id="passwordIcon"></i>
                            </button>
                        </div>
                        <div class="password-strength" id="passwordStrength">
                            <div class="strength-bar" id="strengthBar"></div>
                        </div>
                        <div class="text-xs text-gray-700 mt-1" id="strengthText">Password strength</div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <label class="flex items-center">
                            <input type="checkbox" id="rememberMe" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-700">Remember me</span>
                        </label>
                        <a href="#" id="forgotPasswordLink" class="text-indigo-600 hover:text-indigo-800 transition-colors duration-200">Forgot Password?</a>
                    </div>
                    <button type="submit" id="loginButton" class="w-full text-white py-3 rounded-lg shadow-md hover:scale-105 transform transition duration-300 ripple relative overflow-hidden">
                        <span id="loginButtonText">Login</span>
                        <div id="loginSpinner" class="spinner hidden ml-2"></div>
                    </button>
                </form>
                <div id="signUpContainer" class="text-center text-sm text-black mt-4 hidden">
                    <span>Don't have an account? </span>
                    <a href="#" id="signUpLink" class="font-semibold text-indigo-600 hover:text-indigo-800 hover:underline">Sign Up</a>
                </div>
             </div>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 hidden opacity-0">
    <div class="bg-white/95 backdrop-blur-md p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-transform duration-300 scale-95 border border-white/20 text-black">
             <div class="flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-teal-500 to-teal-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-key text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Password Recovery</h3>
                </div>
                <button id="closeModal" class="text-gray-300 hover:text-white text-2xl hover:scale-110 transition-transform duration-200">&times;</button>
            </div>
            <div id="modalContent">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-teal-100 to-teal-200 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shield-alt text-teal-600 text-2xl"></i>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed">Enter your User ID to receive a personalized security question for password recovery.</p>
                </div>
                <div class="space-y-4">
                    <div class="input-focus">
                        <label for="recoveryUserId" class="block text-gray-200 text-sm font-medium mb-2">
                            <i class="fas fa-user mr-2 text-gray-300"></i>User ID
                        </label>
                        <input type="text" id="recoveryUserId" placeholder="Enter your ID" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-200 bg-gray-50 focus:bg-white">
                    </div>
                    <button id="getQuestionBtn" class="w-full bg-gradient-to-r from-teal-500 to-teal-400 text-white py-3 rounded-lg shadow-md hover:scale-105 transform transition duration-300 flex items-center justify-center ripple relative overflow-hidden">
                        <span id="btnText">✨ Get Security Question</span>
                        <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                    </button>
                </div>
                <div id="questionContainer" class="mt-6 hidden fade-in">
                    <div class="bg-teal-50 border border-teal-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-question-circle text-teal-600 mt-1 mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-teal-800 mb-1">Security Question</p>
                                <label for="securityAnswer" id="securityQuestionLabel" class="block text-gray-200 text-sm"></label>
                            </div>
                        </div>
                    </div>
                    <div class="input-focus">
                        <label for="securityAnswer" class="block text-gray-200 text-sm font-medium mb-2">
                            <i class="fas fa-edit mr-2 text-gray-300"></i>Your Answer
                        </label>
                        <input type="text" id="securityAnswer" placeholder="Enter your answer" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 bg-gray-50 focus:bg-white">
                    </div>
                    <button class="w-full bg-gradient-to-r from-indigo-600 to-indigo-500 text-white py-3 rounded-lg shadow-md hover:scale-105 transform transition duration-300 ripple relative overflow-hidden">
                        <i class="fas fa-check mr-2"></i>
                        Submit Answer
                    </button>
                </div>
                <div id="errorMessage" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm text-center hidden">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorText"></span>
                </div>
                <div id="successMessage" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm text-center hidden">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="successText"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const roleSelectionContainer = document.getElementById('roleSelectionContainer');
        const loginFormContainer = document.getElementById('loginFormContainer');
        const roleCards = document.querySelectorAll('.role-card');
        const backButton = document.getElementById('backButton');
        const formTitle = document.getElementById('formTitle');
        const loginButton = document.getElementById('loginButton');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        const signUpContainer = document.getElementById('signUpContainer');
        
        const togglePassword = document.getElementById('togglePassword');
        const passwordIcon = document.getElementById('passwordIcon');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        const loginButtonText = document.getElementById('loginButtonText');
        const loginSpinner = document.getElementById('loginSpinner');
        const toastContainer = document.getElementById('toastContainer');

        // API base configuration (allows ?apiBase= override). If not provided,
        // prefer the server that is started by `npm start` in this project (port 4000).
        // We also attempt port 4100 as a fallback so the UI works if a different
        // server build is used.
        let API_BASE = null;
        try {
            const params = new URLSearchParams(window.location.search);
            const explicitBase = params.get('apiBase');
            if (explicitBase) API_BASE = explicitBase.replace(/\/$/, '');
        } catch(e) {}
        if (!API_BASE) {
            API_BASE = 'http://127.0.0.1:4000'; // primary default
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // NEW: Initialize the plexus background
            initializePlexusBackground();

            // Existing initializations
            initializePasswordStrength();
            initializePasswordToggle();
            initializeToastSystem();
            initializeRippleEffects();
            initializeScrollReveal();
            // Check API availability on load (don't spam immediately)
            setTimeout(() => attemptApiPing(false), 250);
        });

        // --- NEW: Plexus Background Logic ---
        function initializePlexusBackground() {
            const canvas = document.getElementById('plexus-canvas');
            if (!canvas) return;
            // if canvas is hidden via CSS for this theme, skip initialization
            const style = window.getComputedStyle(canvas);
            if (style && style.display === 'none') return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const config = {
                particleColor: 'rgba(59,130,246,0.85)', // soft blue
                lineColor: 'rgba(59,130,246,0.18)',
                particleAmount: 90,
                defaultRadius: 2,
                variantRadius: 1.2,
                defaultSpeed: 0.45,
                linkRadius: 160,
            };

            let particles = [];
            
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.radius = config.defaultRadius + Math.random() * config.variantRadius;
                    this.speedX = (Math.random() - 0.5) * config.defaultSpeed;
                    this.speedY = (Math.random() - 0.5) * config.defaultSpeed;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = config.particleColor;
                    ctx.shadowColor = 'rgba(59,130,246,0.18)';
                    ctx.shadowBlur = 6;
                    ctx.fill();
                    ctx.closePath();
                }
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
                }
            }

            function setup() {
                for (let i = 0; i < config.particleAmount; i++) {
                    particles.push(new Particle());
                }
            }

            function linkParticles() {
                for (let a = 0; a < particles.length; a++) {
                    for (let b = a; b < particles.length; b++) {
                        const dx = particles[a].x - particles[b].x;
                        const dy = particles[a].y - particles[b].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < config.linkRadius) {
                            ctx.beginPath();
                            ctx.moveTo(particles[a].x, particles[a].y);
                            ctx.lineTo(particles[b].x, particles[b].y);
                            const opacity = 1 - (distance / config.linkRadius);
                            ctx.strokeStyle = `rgba(0, 173, 255, ${opacity * 0.4})`;
                            ctx.lineWidth = 1;
                            ctx.stroke();
                            ctx.closePath();
                        }
                    }
                }
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.shadowBlur = 0;
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                linkParticles();
                requestAnimationFrame(animate);
            }
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                particles = [];
                setup();
            });

            setup();
            animate();
        }

        // --- Existing Logic ---

        function initializePasswordStrength() {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                const strength = calculatePasswordStrength(password);
                updatePasswordStrengthUI(strength);
            });
        }

        function calculatePasswordStrength(password) {
            let score = 0;
            if (password.length >= 8) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            return score;
        }

        function updatePasswordStrengthUI(strength) {
            const strengthClasses = ['strength-weak', 'strength-fair', 'strength-good', 'strength-strong'];
            const strengthLabels = ['Weak', 'Fair', 'Good', 'Strong'];
            strengthBar.className = 'strength-bar ' + (strengthClasses[strength - 1] || '');
            strengthText.textContent = strength > 0 ? `Password strength: ${strengthLabels[strength - 1] || 'Very Weak'}` : 'Password strength';
        }

        function initializePasswordToggle() {
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                passwordIcon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
            });
        }

        function initializeToastSystem() { /* Toast system is ready */ }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle';
            toast.innerHTML = `<div class="flex items-center"><i class="${icon} mr-3 text-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-500"></i><span>${message}</span></div>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Persistent API banner (shown when API is unreachable)
        function ensureApiBanner() {
            if (document.getElementById('apiBanner')) return;
            const b = document.createElement('div');
            b.id = 'apiBanner';
            b.style.position = 'fixed';
            b.style.left = '0';
            b.style.right = '0';
            b.style.top = '0';
            b.style.zIndex = '9999';
            b.style.background = '#fee2e2';
            b.style.color = '#7f1d1d';
            b.style.padding = '10px 16px';
            b.style.display = 'flex';
            b.style.alignItems = 'center';
            b.style.justifyContent = 'space-between';
            b.innerHTML = '<div id="apiBannerText">Cannot reach API. <button id="apiRetryBtn" style="margin-left:12px;padding:6px 10px;background:#dc2626;color:#fff;border:none;border-radius:4px;cursor:pointer">Retry</button> <small style="margin-left:8px;color:#5f4339">(You can also set ?apiBase= in the URL)</small></div>';
            document.body.appendChild(b);
            document.getElementById('apiRetryBtn').addEventListener('click', () => {
                hideApiBanner();
                attemptApiPing(true);
            });
        }

        function showApiBanner(msg) {
            ensureApiBanner();
            const el = document.getElementById('apiBannerText');
            if (el) el.firstChild && (el.firstChild.nodeValue = msg + ' ');
            document.getElementById('apiBanner').style.display = 'flex';
        }

        function hideApiBanner() {
            const b = document.getElementById('apiBanner');
            if (b) b.style.display = 'none';
        }

        // attempt an API ping; if fail show banner. We try a small list of likely
        // local ports (4000 then 4100) so the UI works with either server file.
        let _apiBackoff = 1000;
        async function attemptApiPing(force=false) {
            const explicit = (() => { try { return (new URLSearchParams(window.location.search)).get('apiBase'); } catch (e) { return null; } })();
            const candidates = [];
            if (explicit) candidates.push(explicit.replace(/\/$/, ''));
            if (API_BASE) candidates.push(API_BASE.replace(/\/$/, ''));
            // ensure common fallback order and uniqueness
            ['http://127.0.0.1:4000', 'http://127.0.0.1:4100', window.location.origin].forEach(u => { if (u && !candidates.includes(u)) candidates.push(u); });

            for (const api of candidates) {
                try {
                    const controller = new AbortController();
                    const to = setTimeout(() => controller.abort(), 3500);
                    const url = (api.endsWith('/') ? api.slice(0, -1) : api) + '/health';
                    const r = await fetch(url, { signal: controller.signal });
                    clearTimeout(to);
                    if (r.ok) {
                        API_BASE = api; // pick the first successful base
                        hideApiBanner();
                        _apiBackoff = 1000;
                        return true;
                    }
                } catch (e) {
                    // try next candidate
                    console.warn('API ping failed for', api, e && e.message ? e.message : e);
                }
            }

            // none succeeded
            console.warn('All API ping attempts failed');
            showApiBanner('Cannot reach API. Set ?apiBase= or start the server.');
            if (!force) {
                setTimeout(() => attemptApiPing(), _apiBackoff);
                _apiBackoff = Math.min(30000, Math.floor(_apiBackoff * 1.8));
            }
            return false;
        }

        function initializeRippleEffects() {
            document.querySelectorAll('.ripple').forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple-effect');
                    this.appendChild(ripple);
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        }

        // Soothing scroll-reveal using IntersectionObserver
        function initializeScrollReveal() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        el.classList.add('in-view');
                        observer.unobserve(el);
                    }
                });
            }, { threshold: 0.15, rootMargin: '0px 0px -10% 0px' });

            const cards = document.querySelectorAll('.role-card');
            cards.forEach((card, idx) => {
                card.classList.add('reveal');
                card.style.transitionDelay = (idx * 80) + 'ms';
                observer.observe(card);
            });

            // reveal login form container when shown
            const loginFormContainer = document.getElementById('loginFormContainer');
            if (loginFormContainer) {
                loginFormContainer.classList.add('reveal');
                observer.observe(loginFormContainer);
            }
        }
        
        roleCards.forEach(card => {
            card.addEventListener('click', () => {
                const role = card.dataset.role;
                const color = card.dataset.color;
                console.log('Role card clicked:', role);
                card.style.transform = 'scale(0.95)';
                setTimeout(() => { card.style.transform = ''; }, 150);
                updateLoginForm(role, color);
                showToast(`Accessing ${role} Portal`, 'success');
                roleSelectionContainer.classList.add('slide-out-left');
                setTimeout(() => {
                    roleSelectionContainer.classList.add('hidden');
                    loginFormContainer.classList.remove('hidden');
                    loginFormContainer.classList.remove('slide-out-right');
                    loginFormContainer.classList.add('slide-in-right');
                }, 500);
            });
        });

        backButton.addEventListener('click', () => {
            loginFormContainer.classList.remove('slide-in-right');
            loginFormContainer.classList.add('slide-out-right');
            setTimeout(() => {
                loginFormContainer.classList.add('hidden');
                roleSelectionContainer.classList.remove('hidden');
                roleSelectionContainer.classList.remove('slide-out-left');
                roleSelectionContainer.classList.add('slide-in-left');
            }, 500);
            setTimeout(() => {
                roleSelectionContainer.classList.remove('slide-in-left');
            }, 1100);
        });
        
                // currently-selected role (set when clicking a role card)
                let selectedRole = '';

                function updateLoginForm(role, color) {
                    selectedRole = role || '';
            formTitle.textContent = `${role} Portal`;
            const colorClasses = {
                header: `text-${color}-700`,
                button: `bg-gradient-to-r from-${color}-600 to-${color}-500`,
                ring: `focus:ring-${color}-500`,
                link: `text-${color}-600 hover:text-${color}-800`,
            };
            formTitle.className = `text-3xl font-bold tracking-tight ${colorClasses.header}`;
            loginButton.className = `w-full text-white py-3 rounded-lg shadow-md hover:scale-105 transform transition duration-300 ripple relative overflow-hidden ${colorClasses.button}`;
            userIdInput.className = `w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 transition duration-200 bg-gray-50 focus:bg-white ${colorClasses.ring}`;
            passwordInput.className = `w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 transition duration-200 bg-gray-50 focus:bg-white ${colorClasses.ring}`;
            forgotPasswordLink.className = `text-indigo-600 hover:text-indigo-800 transition-colors duration-200 ${colorClasses.link}`;
            const signUpLink = document.getElementById('signUpLink');
            if (role === 'Administrator') {
                signUpContainer.classList.remove('hidden');
                signUpLink.className = `font-semibold text-indigo-600 hover:text-indigo-800 hover:underline ${colorClasses.link}`;
            } else {
                signUpContainer.classList.add('hidden');
            }
        }
        
        document.querySelectorAll('.role-card').forEach(card => {
        // preserve role-card class so our core styles remain applied
        card.className = "role-card bg-white/95 p-6 rounded-2xl shadow-lg cursor-pointer transform hover:-translate-y-2 transition-all duration-300 group idle-float border border-gray-200 text-black reveal";
        });
        
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const closeModal = document.getElementById('closeModal');
        const getQuestionBtn = document.getElementById('getQuestionBtn');
        const recoveryUserIdInput = document.getElementById('recoveryUserId');
        const questionContainer = document.getElementById('questionContainer');
        const securityQuestionLabel = document.getElementById('securityQuestionLabel');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const btnText = document.getElementById('btnText');
        const loginForm = document.getElementById('loginForm');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = userIdInput.value.trim();
            const password = passwordInput.value;
            if (!userId || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            loginButton.disabled = true;
            loginButtonText.textContent = 'Signing in...';
            loginSpinner.classList.remove('hidden');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const base = (API_BASE || (new URLSearchParams(window.location.search)).get('apiBase') || '').replace(/\/$/, '') || '';
                const res = await fetch((base || '') + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, password, role: (selectedRole || '').toLowerCase() }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!res.ok) {
                    let msg = 'Login failed';
                    try { const j = await res.json(); if (j && j.error) msg = j.error; } catch(_) {
                      try { const t = await res.text(); if (t) msg = t; } catch(__) {}
                    }
                    showToast(msg + ` (status ${res.status})`, 'error');
                    return;
                }
                // remember user id if requested
                try {
                  const remember = document.getElementById('rememberMe');
                  if (remember && remember.checked) localStorage.setItem('alumni_login_id', userId);
                } catch(e) {}

                                // Use server-returned role when available (safer). Fall back to
                                // the client-selected role when server doesn't provide role.
                                let json = {};
                                try { json = await res.json(); } catch(e) { json = {}; }
                                let srvRole = (json && json.role) ? String(json.role).toLowerCase() : '';
                                let roleStr = srvRole || (selectedRole || '').trim();
                                if (!roleStr) {
                                    try { roleStr = (formTitle && formTitle.textContent) ? formTitle.textContent.replace(/\s+Portal$/,'') : ''; } catch(e) { roleStr = ''; }
                                }
                                const r = (roleStr || '').toLowerCase();
                                let target = 'mainad.html';
                                if (r.includes('student')) target = 'mainst.html';
                                else if (r.includes('alumni')) target = 'mainalu.html';
                                else if (r.includes('administrator') || r.includes('admin')) target = 'mainad.html';

                showToast('Login successful! Redirecting...', 'success');
                setTimeout(() => { window.location.href = target; }, 700);
            } catch (error) {
                // Network / reachability error: ensure banner is shown and schedule a retry
                console.warn('Login request failed', error && error.message ? error.message : error);
                showToast('Cannot reach API. Set ?apiBase= or start the server.', 'error');
                attemptApiPing(true);
            } finally {
                loginButton.disabled = false;
                loginButtonText.textContent = 'Login';
                loginSpinner.classList.add('hidden');
            }
        });

        const showModal = () => {
            forgotPasswordModal.classList.remove('hidden');
            setTimeout(() => {
                forgotPasswordModal.classList.remove('opacity-0');
                forgotPasswordModal.querySelector('div').classList.remove('scale-95');
            }, 10);
        };

        const hideModal = () => {
            forgotPasswordModal.classList.add('opacity-0');
            forgotPasswordModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                forgotPasswordModal.classList.add('hidden');
                questionContainer.classList.add('hidden');
                recoveryUserIdInput.value = '';
                errorMessage.classList.add('hidden');
                successMessage.classList.add('hidden');
                securityQuestionLabel.textContent = '';
                document.getElementById('securityAnswer').value = '';
            }, 300);
        };

        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const currentUserId = document.getElementById('userId').value;
            if(currentUserId) recoveryUserIdInput.value = currentUserId;
            showModal();
        });

        closeModal.addEventListener('click', hideModal);
        forgotPasswordModal.addEventListener('click', (e) => {
            if (e.target === forgotPasswordModal) hideModal();
        });

        getQuestionBtn.addEventListener('click', async () => {
            const userId = recoveryUserIdInput.value.trim();
            if (!userId) {
                showError('Please enter your User ID.');
                return;
            }
            setLoading(true);
            hideMessages();
            try {
                await new Promise(res => setTimeout(res, 1500));
                const questions = [
                    "What was your favorite hidden spot on campus?", "What was the name of your first pet?",
                    "What was your childhood nickname?", "What was the name of your elementary school?",
                    "What was your favorite subject in college?"
                ];
                const question = questions[Math.floor(Math.random() * questions.length)];
                securityQuestionLabel.textContent = question;
                questionContainer.classList.remove('hidden');
                showToast('Security question generated successfully', 'success');
            } catch (error) {
                showError('Could not generate a question. Please try again.');
            } finally {
                setLoading(false);
            }
        });

        document.getElementById('securityAnswer').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitSecurityAnswer();
        });

        function submitSecurityAnswer() {
            const answer = document.getElementById('securityAnswer').value.trim();
            if (!answer) {
                showError('Please enter your answer.');
                return;
            }
            setTimeout(() => {
                if (answer.length >= 3) {
                    showSuccess('Answer accepted! Password reset instructions sent to your email.');
                    setTimeout(() => {
                        hideModal();
                        showToast('Password reset email sent successfully', 'success');
                    }, 2000);
                } else {
                    showError('Incorrect answer. Please try again.');
                }
            }, 1000);
        }

        function setLoading(isLoading) {
            getQuestionBtn.disabled = isLoading;
            loadingSpinner.classList.toggle('hidden', !isLoading);
            btnText.textContent = isLoading ? 'Generating...' : '✨ Get Security Question';
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }
    </script>
</body>
</html>